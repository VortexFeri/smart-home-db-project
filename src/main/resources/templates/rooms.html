<!DOCTYPE html >
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<div th:each="entry : ${list}">
    <h2 th:text="${entry.room.name}"></h2>
    <a th:href="@{'/rooms/' + ${entry.room.id}}">Edit</a>
    <table>
        <thead>
        <tr>
            <th>Device Name</th>
            <th>Device Count</th>
            <th>Device Wattage</th>
            <th>Monthly Consumption</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="device : ${entry.deviceMap.entrySet()}">
            <td th:text="${device.key.name}"></td>
            <th th:text="${device.value}"></th>
            <td th:text="${device.key.wattage}"></td>
            <td th:text="${device.key.wattage * device.value * 30}"></td>
        </tr>
        </tbody>
    </table>
</div>
<div th:each="entry, iterStat : ${list}" th:id="${'chart' + entry.room.id}" class="chart"></div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script>

    const extractedDevices = {};


    fetch('/rooms/room-list', {
        method: 'GET'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then((res) => {
        res.forEach(entry => {
            const options = {
            chart: {
                type: 'pie',
                options3d: {
                    enabled: true,
                    alpha: 45,
                    beta: 0
                }
            },
            title: {
                text: ''
            },
            plotOptions: {
                pie: {
                    depth: 45
                }
            },
            series: [{
                name: 'Total Power Consumption',
                data: [
                ]
            }]
            };

            let keys = Object.keys(entry.map)
            keys.forEach(key => options.series[0].data.push({name: key, y: entry.map[key]}));
            options.title.text = entry.roomName
            console.log(options)
            const chart = Highcharts.chart("chart" + entry.roomID, options);
        })
    })
    .catch(err => {
    console.error('Error during fetching devices:', err);
    });

</script>

</body>
</html>